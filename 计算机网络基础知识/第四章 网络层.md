# 第四章 网络层

## 4.1 网络层概述

网络层的主要任务是**实现网络互连**，进而**实现数据包在各网络之间的传输**。

要实现网络层任务，需要解决以下问题

1. 网络层向运输层提供怎样的服务（“可靠传输”还是“不可靠传输”）

   对于误码、（被路由器）丢弃、或失序（按序发送的数据包不能按序到达），如果不采取任何措施，则是不可靠传输服务；如果采取措施，并使得接收方能正确接收数据包，则是可靠传输服务。

2. 网络层寻址问题

<img src="images/image-20210706194642694.png" alt="image-20210706194642694" style="zoom: 50%;" />

3. 路由选择问题

路由器收到数据包后，是依据什么来决定，将数据包从自己的哪个接口转发出去呢？

<img src="images/image-20210706194852236.png" alt="image-20210706194852236" style="zoom: 33%;" />

![image-20210706195004954](images/image-20210706195004954.png)

![image-20210706195050873](images/image-20210706195050873.png)

## 4.2 网络层提供的两种服务

### 面向连接的虚电路(virtual circuit)服务

<img src="images/image-20210706200423697.png" alt="image-20210706200423697" style="zoom:33%;" />

<img src="images/image-20210706200721654.png" alt="image-20210706200721654" style="zoom:50%;" />

### 无连接的数据报服务

<img src="images/image-20210706200904137.png" alt="image-20210706200904137" style="zoom: 50%;" />

<img src="images/image-20210706200936295.png" alt="image-20210706200936295" style="zoom:50%;" />

### 小结

![image-20210706201017038](images/image-20210706201017038.png)

## 4.3 IPv4地址及其应用

### 4.3.1 概述

<img src="images/image-20210706201306213.png" alt="image-20210706201306213" style="zoom: 50%;" />

#### IPv4地址的表示方法——点分十进制表示方法

<img src="images/image-20210706201518532.png" alt="image-20210706201518532" style="zoom:50%;" />

#### 8位二进制整数转为十进制数

![image-20210706201643294](images/image-20210706201643294.png)

二进制转十进制的举例：

![image-20210706201843939](images/image-20210706201843939.png)

#### 十进制正整数转为8进制二进制数——除2取余法/凑值法

![image-20210706202227884](images/image-20210706202227884.png)

慕课题：

<img src="images/image-20210706202514054.png" alt="image-20210706202514054" style="zoom: 50%;" />

### 4.3.2 分类编址的IPv4地址

五类地址：

<img src="images/image-20210706205333839.png" alt="image-20210706205333839" style="zoom:50%;" />

#### A类地址

![image-20210706210456533](images/image-20210706210456533.png)

#### B类地址

![image-20210706210723798](images/image-20210706210723798.png)

#### C类地址

![image-20210706210859960](images/image-20210706210859960.png)

练习：

![image-20210706211000104](images/image-20210706211000104.png)

![image-20210706211150014](images/image-20210706211150014.png)

<img src="images/image-20210706211446639.png" alt="image-20210706211446639" style="zoom: 50%;" />

![image-20210706211525100](images/image-20210706211525100.png)

![image-20210706211955019](images/image-20210706211955019.png)

慕课题：

<img src="images/image-20210706212536171.png" alt="image-20210706212536171" style="zoom: 50%;" />

### 4.3.3 划分子网的IPv4地址

划分子网需求的出现

如图，某单位有个大型局域网需要连接到因特网，申请C类的话IP地址数量太少，B类的话有可能会太多。

<img src="images/image-20210706212914703.png" alt="image-20210706212914703" style="zoom:50%;" />

随着该单位的发展，有可能需要划分成三个独立的网络：

<img src="images/image-20210706213047459.png" alt="image-20210706213047459" style="zoom: 33%;" />

但是，可以从主机号部分借用一部分作为子网号：

![image-20210706213311788](images/image-20210706213311788.png)

但是，如果未在图中标记子网号部分，那么我们和计算机又如何知道分类地址中主机号有多少比特被用作子网号了呢？

#### 子网掩码

<img src="images/image-20210706213604561.png" alt="image-20210706213604561" style="zoom:50%;" />

#### 划分子网的细节

![image-20210706214538008](images/image-20210706214538008.png)

作为C类网的所以IP地址：

<img src="images/image-20210706214826930.png" alt="image-20210706214826930" style="zoom: 33%;" />

划分子网后的IP地址：

![image-20210706215039415](images/image-20210706215039415.png)

练习题与考研题：

<img src="images/image-20210706215110054.png" alt="image-20210706215110054" style="zoom: 33%;" />

![image-20210706215240311](images/image-20210706215240311.png)

<img src="images/image-20210706215341719.png" alt="image-20210706215341719" style="zoom: 45%;" />

#### 默认子网掩码

<img src="images/image-20210706215510825.png" alt="image-20210706215510825" style="zoom: 50%;" />

### 4.4.4 无分类编址的IPv4地址

<img src="images/image-20210706215827781.png" alt="image-20210706215827781" style="zoom:50%;" />

#### 无分类域间路由选择CIDR

<img src="images/image-20210706220058517.png" alt="image-20210706220058517" style="zoom: 33%;" />

##### 举例说明细节

![image-20210706220757355](images/image-20210706220757355.png)

##### 路由聚合（构造超网）

<img src="images/image-20210706221350281.png" alt="image-20210706221350281" style="zoom: 33%;" />

考研题目：

<img src="images/image-20210706221827230.png" alt="image-20210706221827230" style="zoom:40%;" />

<img src="images/image-20210706221945594.png" alt="image-20210706221945594" style="zoom:30%;" />

#### 小结

![image-20210706222033801](images/image-20210706222033801.png)

### 4.4.5 IPv4地址的应用规划

应用规划：给定一个IPv4地址块，如何将其划分成几个更小的地址块，并将这些地址块分配给互联网中的不同网络，进而可以给各网络中的主机和路由器接口分配IPv4地址。一般有以下两种方法：

![image-20210708101239567](images/image-20210708101239567.png)

#### FLSM

<img src="images/image-20210708102353871.png" alt="image-20210708102353871" style="zoom: 33%;" />

分析完需求后，问题可以简化为：

![image-20210708102905197](images/image-20210708102905197.png)

最后，划分子网的细节：

![image-20210708103050329](images/image-20210708103050329.png)

最后就是任选5各分配给图中所给出的网络。

#### VLSM

使用大致相同的例子

<img src="images/image-20210708104116747.png" alt="image-20210708104116747" style="zoom:50%;" />

则，需求可以转化为：

<img src="images/image-20210708104742573.png" alt="image-20210708104742573" style="zoom:50%;" />

最后，划分子网的细节：

<img src="images/image-20210708104945216.png" alt="image-20210708104945216" style="zoom:50%;" />

小结：

![image-20210826112549637](images/image-20210826112549637.png)

## 4.4 IP数据报的发送和转发过程

![image-20210706222145470](images/image-20210706222145470.png)

直接交付：同一个网络中的主机之间

间接交付：不同网络中的主机之间，需要路由器

默认网关：用户为了让本网络的主机能和其他网络中的主机进行通信，必须指定给其指定本网络中的一个路由器，所指定的路由器就称为默认网关

![image-20210826210026229](images/image-20210826210026229.png)

![image-20210826210721019](images/image-20210826210721019.png)

![image-20210826210801458](images/image-20210826210801458.png)

课堂小测：

![image-20210826210839529](images/image-20210826210839529.png)



小结：

![image-20210826212009163](images/image-20210826212009163.png)

## 4.5 静态路由配置及其可能产生的路由环路问题

### 定义![image-20210826212934378](images/image-20210826212934378.png)

### 举例

- 直连路由：![image-20210826213821459](images/image-20210826213821459.png)

- 静态路由：![image-20210826213537506](images/image-20210826213537506.png)

- 默认路由：![image-20210826214311079](images/image-20210826214311079.png)

![image-20210826214530889](images/image-20210826214530889.png)

- 特定主机路由：一般用于网络管理人员对网络的管理和测试。![image-20210826214701524](images/image-20210826214701524.png)

特定主机路由网络前缀最长，路由最具体；而默认路由网络前缀最端，路由最模糊。**多条路由可选时，采用“最长前缀匹配”原则**，选用网络前缀最长的那个路由条目进行转发。

### 问题

![image-20210826212948143](images/image-20210826212948143.png)

- 静态路由配置错误导致的路由环路

![image-20210826215343328](images/image-20210826215343328.png)



- 聚合了不存在的网络而导致的路由环路

聚合路由的概念：![image-20210826221216476](images/image-20210826221216476.png)

问题举例：

![image-20210826221315432](images/image-20210826221315432.png)

解决方法：添加黑洞路由

<img src="images/image-20210826221413930.png" alt="image-20210826221413930" style="zoom: 33%;" />



- 网络故障而导致的路由环路

![image-20210826221644359](images/image-20210826221644359.png)

解决方法：添加针对该网络故障的网络的黑洞路由

![image-20210826222224058](images/image-20210826222224058.png)

如果网络故障消失后，则R1又自动得出了其接口0的直连网络的路由条目，并把人工配置的针对该直连网络的黑洞路由条目设置为失效状态。

### 小结

![image-20210826222443915](images/image-20210826222443915.png)

